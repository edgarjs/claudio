#!/bin/bash
# Safeguard wrapper: prevents Claude from restarting/stopping its own service.
# Shadows the real launchctl when CLAUDIO_WEBHOOK_ACTIVE=1.
# Blocks only stop/unload/kickstart -k targeting the claudio service;
# all other invocations are passed through to the real launchctl.

set -euo pipefail

_find_real() {
    local self_dir
    self_dir="$(cd "$(dirname "$0")" && pwd)"
    local IFS=':'
    for dir in $PATH; do
        [ "$dir" = "$self_dir" ] && continue
        if [ -x "$dir/launchctl" ]; then
            printf '%s' "$dir/launchctl"
            return 0
        fi
    done
    echo "launchctl: real binary not found" >&2
    return 127
}

# Only intercept when running inside a webhook handler
if [ "${CLAUDIO_WEBHOOK_ACTIVE:-}" != "1" ]; then
    real=$(_find_real)
    exec "$real" "$@"
fi

# Check if this is a destructive command targeting the claudio service
blocked=false
action=""
for arg in "$@"; do
    case "$arg" in
        stop|unload) action="$arg" ;;
        *claudio*) [ -n "$action" ] && blocked=true ;;
    esac
done

# Also catch: launchctl kickstart -k ... claudio
if [[ " $* " == *" kickstart "* ]] && [[ " $* " == *" -k "* ]] && [[ " $* " == *"claudio"* ]]; then
    blocked=true
fi

if [ "$blocked" = true ]; then
    echo "BLOCKED: 'launchctl $*' was blocked by Claudio's self-restart safeguard." >&2
    echo "Reason: Running this command from a webhook handler would kill your own process." >&2
    echo "Changes to lib/*.sh take effect on the next webhook automatically." >&2
    exit 1
fi

# Pass through all other launchctl commands
real=$(_find_real)
exec "$real" "$@"
