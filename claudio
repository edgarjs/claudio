#!/bin/bash

set -e

# Resolve symlinks to get the actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # Handle relative symlinks
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
VERSION=$(cat "$SCRIPT_DIR/VERSION" 2>/dev/null) || VERSION="unknown"

# Source library files
# shellcheck source=lib/config.sh
source "$LIB_DIR/config.sh"
# shellcheck source=lib/history.sh
source "$LIB_DIR/history.sh"
# shellcheck source=lib/claude.sh
source "$LIB_DIR/claude.sh"
# shellcheck source=lib/telegram.sh
source "$LIB_DIR/telegram.sh"
# shellcheck source=lib/whatsapp.sh
source "$LIB_DIR/whatsapp.sh"
# shellcheck source=lib/server.sh
source "$LIB_DIR/server.sh"
# shellcheck source=lib/service.sh
source "$LIB_DIR/service.sh"
# shellcheck source=lib/backup.sh
source "$LIB_DIR/backup.sh"
# shellcheck source=lib/tts.sh
source "$LIB_DIR/tts.sh"
# shellcheck source=lib/stt.sh
source "$LIB_DIR/stt.sh"
# shellcheck source=lib/memory.sh
source "$LIB_DIR/memory.sh"

usage() {
    cat <<EOF
Claudio v${VERSION} - Telegram to Claude Code bridge

Usage: claudio <command> [options]

Commands:
  status             Show service and webhook status
  start              Start the HTTP server
  install [bot_name] Install system service + configure a bot (default: "claudio")
  uninstall <bot>    Remove a bot's config (with confirmation)
  uninstall --purge  Stop service, remove all data
  update             Update to the latest release
  restart            Restart the service
  telegram setup     Set up Telegram bot and webhook
  whatsapp setup     Set up WhatsApp Business API webhook
  log [-f] [-n N]    Show logs (-f to follow, -n for line count)
  backup <dest>      Run backup (--hours N, --days N for retention)
  backup status <dest> Show backup status
  backup cron <dest> Install/remove hourly backup cron job
  version            Show version

EOF
    exit 1
}

claudio_init

# Parse --hours and --days flags from remaining args, setting
# parsed_hours and parsed_days variables in the caller's scope
_parse_retention_args() {
    parsed_hours=24
    parsed_days=7
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --hours)
                if [[ -z "${2:-}" || ! "$2" =~ ^[0-9]+$ ]]; then
                    echo "Error: --hours requires a positive integer." >&2; exit 1
                fi
                parsed_hours="$2"; shift 2 ;;
            --days)
                if [[ -z "${2:-}" || ! "$2" =~ ^[0-9]+$ ]]; then
                    echo "Error: --days requires a positive integer." >&2; exit 1
                fi
                parsed_days="$2"; shift 2 ;;
            *) echo "Error: Unknown argument '$1'." >&2; exit 1 ;;
        esac
    done
}

case "${1:-}" in
    version|--version|-v)
        echo "claudio v${VERSION}"
        exit 0
        ;;
    _webhook)
        # Load per-bot config from CLAUDIO_BOT_ID (set by server.py)
        if [ -n "$CLAUDIO_BOT_ID" ]; then
            claudio_load_bot "$CLAUDIO_BOT_ID"
        fi
        history_init
        memory_init
        body=$(cat)
        # Call appropriate handler based on platform passed from server.py
        local platform="${2:-}"
        if [ "$platform" = "whatsapp" ]; then
            whatsapp_handle_webhook "$body"
        elif [ "$platform" = "telegram" ]; then
            telegram_handle_webhook "$body"
        else
            log_error "webhook" "Unknown platform '$platform' for bot $CLAUDIO_BOT_ID"
        fi
        ;;
    status)
        service_status
        ;;
    start)
        server_start
        ;;
    install)
        service_install "${2:-}"
        ;;
    uninstall)
        service_uninstall "${2:-}"
        ;;
    update)
        service_update
        ;;
    restart)
        service_restart
        ;;
    log)
        shift
        follow=false
        lines=50
        while [[ $# -gt 0 ]]; do
            case "$1" in
                -f|--follow) follow=true; shift ;;
                -n|--lines)
                    if [[ -z "${2:-}" || ! "$2" =~ ^[0-9]+$ ]]; then
                        echo "Error: -n/--lines requires a positive integer argument." >&2
                        exit 1
                    fi
                    lines="$2"; shift 2 ;;
                *) echo "Error: Unknown argument '$1'. Usage: claudio log [-f|--follow] [-n|--lines N]" >&2; exit 1 ;;
            esac
        done
        if [[ ! -f "$CLAUDIO_LOG_FILE" ]]; then
            echo "No log file found at $CLAUDIO_LOG_FILE"
            exit 1
        fi
        tail_args=(-n "$lines")
        if $follow; then
            tail_args+=(-f)
        fi
        tail "${tail_args[@]}" "$CLAUDIO_LOG_FILE"
        ;;
    backup)
        shift
        backup_subcmd="${1:-}"
        case "$backup_subcmd" in
            status)
                if [[ -z "${2:-}" ]]; then
                    echo "Usage: claudio backup status <destination>" >&2
                    exit 1
                fi
                backup_status "$2"
                ;;
            cron)
                shift
                cron_action="${1:-install}"
                case "$cron_action" in
                    install)
                        shift || true
                        backup_dest="${1:-}"
                        if [[ -z "$backup_dest" ]]; then
                            echo "Usage: claudio backup cron install <destination> [--hours N] [--days N]" >&2
                            exit 1
                        fi
                        shift
                        _parse_retention_args "$@"
                        backup_cron_install "$backup_dest" "$parsed_hours" "$parsed_days"
                        ;;
                    uninstall|remove)
                        backup_cron_uninstall
                        ;;
                    *)
                        echo "Usage: claudio backup cron {install <dest> [--hours N] [--days N]|uninstall}" >&2
                        exit 1
                        ;;
                esac
                ;;
            ""|--help|-h)
                echo "Usage: claudio backup <destination> [--hours N] [--days N]"
                echo "       claudio backup status <destination>"
                echo "       claudio backup cron install <destination> [--hours N] [--days N]"
                echo "       claudio backup cron uninstall"
                exit 0
                ;;
            *)
                # Direct backup run: claudio backup <dest> [--hours N] [--days N]
                backup_dest="$backup_subcmd"
                shift || true
                _parse_retention_args "$@"
                backup_run "$backup_dest" "$parsed_hours" "$parsed_days"
                ;;
        esac
        ;;
    telegram)
        case "${2:-}" in
            setup)
                telegram_setup
                ;;
            *)
                echo "Usage: claudio telegram setup"
                exit 1
                ;;
        esac
        ;;
    whatsapp)
        case "${2:-}" in
            setup)
                whatsapp_setup
                ;;
            *)
                echo "Usage: claudio whatsapp setup"
                exit 1
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac
