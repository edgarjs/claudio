#!/bin/bash

set -e

# Resolve symlinks to get the actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # Handle relative symlinks
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
VERSION=$(cat "$SCRIPT_DIR/VERSION")

# Source library files
# shellcheck source=lib/config.sh
source "$LIB_DIR/config.sh"
# shellcheck source=lib/history.sh
source "$LIB_DIR/history.sh"
# shellcheck source=lib/claude.sh
source "$LIB_DIR/claude.sh"
# shellcheck source=lib/telegram.sh
source "$LIB_DIR/telegram.sh"
# shellcheck source=lib/server.sh
source "$LIB_DIR/server.sh"
# shellcheck source=lib/service.sh
source "$LIB_DIR/service.sh"

usage() {
    cat <<EOF
Claudio v${VERSION} - Telegram to Claude Code bridge

Usage: claudio <command> [options]

Commands:
  status             Show service and webhook status
  start              Start the HTTP server
  install [--user <name>]  Install the service (--user creates system user, requires root)
  uninstall [--purge] Stop and remove the service (--purge removes all data)
  update             Update to the latest release
  restart            Restart the service
  telegram setup     Set up Telegram bot and webhook
  version            Show version

EOF
    exit 1
}

claudio_init

case "${1:-}" in
    version|--version|-v)
        echo "claudio v${VERSION}"
        exit 0
        ;;
    _webhook)
        history_init
        telegram_handle_webhook "$2"
        ;;
    status)
        service_status
        ;;
    start)
        history_init
        server_start
        ;;
    install)
        target_user=""
        if [ "${2:-}" = "--user" ]; then
            target_user="${3:-}"
            if [ -z "$target_user" ]; then
                echo "Error: --user requires a username argument"
                echo "Usage: claudio install --user <username>"
                exit 1
            fi
        fi
        service_install "$target_user"
        ;;
    uninstall)
        service_uninstall "${2:-}"
        ;;
    update)
        service_update
        ;;
    restart)
        service_restart
        ;;
    telegram)
        case "${2:-}" in
            setup)
                telegram_setup
                ;;
            *)
                echo "Usage: claudio telegram setup"
                exit 1
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac
